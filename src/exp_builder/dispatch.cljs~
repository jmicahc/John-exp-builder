(ns ^:figwheel-always exp-builder.dispatch
  (:require [exp-builder.data :as data]))

(declare rx)

(defmulti inner 
  (fn [form & _] (:class form)))


(defmethod inner :layout
  [form index path outer]
  (let [new-path (conj path :children index)
        new-form (assoc form :path new-path)
        x (outer new-form)]
    (if (fn? x)
      (rx new-form outer new-path)
      x)))


(defmethod inner :wrapper
  [form index path outer]
  (let [new-path (conj path :children index)
        new-form (assoc form :path new-path)
        x (outer new-form)]
    (if (fn? x)
      (rx new-form outer new-path)
      x)))


(defn rx
  ([node outer] (rx (assoc node :root true) outer []))
  ([{:keys [children] :as form} outer path]
   (if (sequential? children)
     (let [x (outer form)]
       (if (fn? x)
         (x (mapv (fn [c i] (inner c i path outer)) children (range)))
         x))
     (outer form))))
